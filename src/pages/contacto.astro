---
import Layout from '../layouts/Layout.astro';
const title = "Contacto | Maserati";
---

<Layout title={title}>
    <div class="bg-maserati-negro pt-32 pb-12 px-6 text-center relative z-10">
        <h1 class="text-4xl md:text-5xl font-bold text-maserati-blanco mb-4 tracking-tight">
            Estamos a su <span class="text-maserati-amber">Disposición</span>
        </h1>
        <p class="text-maserati-plata max-w-2xl mx-auto text-lg">
            Nuestro equipo de concierges está listo para atender cualquier consulta.
        </p>
    </div>

    <section class="bg-maserati-negro pb-24 px-6">
        <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-20">
            
            <div class="flex flex-col justify-between">
                
                <div class="space-y-12">
                    <div>
                        <h3 class="text-white text-lg font-bold uppercase tracking-widest mb-6 border-l-2 border-maserati-azul pl-4">
                            Sede Central
                        </h3>
                        <div class="flex items-start gap-4 text-maserati-plata">
                            <svg class="w-6 h-6 text-maserati-amber shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <p class="leading-relaxed">
                                Viale Ciro Menotti, 322<br>
                                41121 Modena MO, Italia
                            </p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-white text-lg font-bold uppercase tracking-widest mb-6 border-l-2 border-maserati-azul pl-4 mt-4">
                            Atención al Cliente
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4 text-maserati-plata">
                                <svg class="w-6 h-6 text-maserati-amber shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                <span>+39 059 590 511</span>
                            </div>
                            <div class="flex items-center gap-4 text-maserati-plata">
                                <svg class="w-6 h-6 text-maserati-amber shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <span>info@maserati.com</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-white text-lg font-bold uppercase tracking-widest mb-6 border-l-2 border-maserati-azul pl-4 mt-4">
                            Horario Showroom
                        </h3>
                        <div class="flex items-start gap-4 text-maserati-plata">
                            <svg class="w-6 h-6 text-maserati-amber shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="leading-relaxed">
                                Lun - Vie: 09:00 - 19:00<br>
                                Sábado: Cita Previa
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mt-16 bg-maserati-gris/30 p-6 rounded-lg border border-white/5">
                    <h3 class="text-white text-sm font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                        <svg class="w-4 h-4 text-maserati-amber" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Concesionarios Cercanos
                    </h3>
                    
                    <div id="dealership-container" class="space-y-4">
                        <p class="text-xs text-maserati-plata animate-pulse">Detectando ubicación...</p>
                    </div>
                    
                    <button id="locate-btn" class="mt-4 text-xs text-maserati-white hover:text-maserati-amber underline transition-colors">
                        Actualizar ubicación
                    </button>
                </div>

            </div>

            <div class="bg-maserati-gris/20 p-8 md:p-10 rounded-xl border border-white/5 backdrop-blur-sm shadow-2xl h-fit">
                
                <h3 class="text-white text-2xl font-bold mb-8">Envíenos un mensaje</h3>

                <form id="contact-form" class="space-y-5">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="name" class="block text-[10px] font-bold text-maserati-plata uppercase tracking-widest mb-1">Nombre</label>
                            <input type="text" id="name" name="name" placeholder="Su nombre"
                                class="w-full bg-maserati-negro border border-white/10 text-white px-3 py-2 text-sm rounded focus:outline-none focus:border-maserati-azul focus:ring-1 focus:ring-maserati-azul transition-all placeholder-white/30"
                                minlength="3" required
                            />
                        </div>
                        <div>
                            <label for="email" class="block text-[10px] font-bold text-maserati-plata uppercase tracking-widest mb-1">Email</label>
                            <input type="email" id="email" name="email" placeholder="correo@ejemplo.com"
                                class="w-full bg-maserati-negro border border-white/10 text-white px-3 py-2 text-sm rounded focus:outline-none focus:border-maserati-azul focus:ring-1 focus:ring-maserati-azul transition-all placeholder-white/30" required
                            />
                        </div>
                    </div>

                    <div>
                        <label for="subject" class="block text-[10px] font-bold text-maserati-plata uppercase tracking-widest mb-1">Asunto</label>
                        <select id="subject" name="subject" 
                            class="w-full bg-maserati-negro border border-white/10 text-white px-3 py-2 text-sm rounded focus:outline-none focus:border-maserati-azul focus:ring-1 focus:ring-maserati-azul transition-all appearance-none" required
                        >
                            <option value="">Seleccione un motivo</option>
                            <option value="info">Información General</option>
                            <option value="test-drive">Solicitar Test Drive</option>
                            <option value="eventos">Eventos Exclusivos</option>
                        </select>
                    </div>

                    <div>
                        <label for="message" class="block text-[10px] font-bold text-maserati-plata uppercase tracking-widest mb-1">Mensaje</label>
                        <textarea id="message" name="message" rows="4" placeholder="¿En qué podemos ayudarle?"
                            class="w-full bg-maserati-negro border border-white/10 text-white px-3 py-2 text-sm rounded focus:outline-none focus:border-maserati-azul focus:ring-1 focus:ring-maserati-azul transition-all placeholder-white/30 resize-none" required minlength="20"
                        ></textarea>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full bg-maserati-azul text-white font-bold py-3 mt-2 rounded uppercase text-xs tracking-widest hover:bg-maserati-amber hover:text-black transition-all shadow-lg shadow-maserati-azul/20">
                        Enviar Solicitud
                    </button>

                    <div id="feedback-success" class="hidden text-green-400 text-xs text-center font-semibold mt-4">✓ Enviado correctamente.</div>
                    <div id="feedback-error" class="hidden text-red-400 text-xs text-center font-semibold mt-4">⚠ Rellene todos los campos.</div>

                </form>
            </div>

        </div>
    </section>
</Layout>

<script>
    
    interface Dealership {
        name: string;
        lat: number;
        lon: number;
        address: string;
        type: string; 
        dist?: number; 
    }

    const dealershipContainer = document.getElementById('dealership-container');
    const locateBtn = document.getElementById('locate-btn');


    const dealerships: Dealership[] = [
        { name: "Maserati Zaragoza - Automóviles Sánchez", lat: 41.66315200961471, lon: -0.9273036436213926, address: "Av. de Logroño, 32, 50011 Zaragoza", type: "Oficial" },
        { name: "Maserati Madrid - Tayre", lat: 40.4168, lon: -3.6700, address: "C/ de López de Hoyos, 62, Madrid", type: "Oficial" },
        { name: "Maserati Madrid - Astara", lat: 40.5300, lon: -3.6500, address: "Av. de Burgos, 114, Madrid", type: "Oficial" },
        { name: "Maserati Barcelona - Cars Gallery", lat: 41.3800, lon: 2.1200, address: "Passeig de la Zona Franca, 10, BCN", type: "Oficial" },
        { name: "Maserati Valencia - Quadis", lat: 39.4700, lon: -0.4000, address: "Av. General Avilés, 36, Valencia", type: "Oficial" },
        { name: "Maserati Marbella - C. de Salamanca", lat: 36.5000, lon: -4.9000, address: "Av. Norberto Goizueta, San Pedro", type: "Oficial" },
        { name: "Maserati Málaga", lat: 36.7200, lon: -4.4200, address: "Calle Cuevas Bajas, 3, Málaga", type: "Servicio Autorizado" },
        { name: "Maserati Bilbao - Grupo Eibar", lat: 43.2600, lon: -2.9300, address: "Gran Vía Don Diego López, Bilbao", type: "Oficial" },
        { name: "Maserati Sevilla - Avisa", lat: 37.3800, lon: -5.9800, address: "Calle del Motor, 1, Sevilla", type: "Oficial" },
        { name: "Maserati Vigo - Celtamotor", lat: 42.2400, lon: -8.7200, address: "Ctra. de Camposancos, 16, Vigo", type: "Oficial" },
        { name: "Maserati Mallorca", lat: 39.6000, lon: 2.6500, address: "Gran Via Asima, 26, Palma", type: "Oficial" },
        { name: "Maserati Lisboa (Portugal)", lat: 38.7200, lon: -9.1400, address: "Rua do Proletariado 16, Carnaxide", type: "Oficial" },
        { name: "Maserati Porto (Portugal)", lat: 41.1500, lon: -8.6200, address: "R. de Manuel Pinto de Azevedo, Porto", type: "Oficial" }
    ];


    function calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {
        const R = 6371; // Radio tierra km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c; 
    }

    function findNearest(lat: number, lon: number) {
        const sorted = dealerships.map(dealer => {
            return { ...dealer, dist: calculateDistance(lat, lon, dealer.lat, dealer.lon) };
        }).sort((a, b) => (a.dist || 0) - (b.dist || 0)); 

        renderDealerships(sorted.slice(0, 3));
    }

    function renderDealerships(list: Dealership[]) {
        if(!dealershipContainer) return;
        
        dealershipContainer.innerHTML = list.map(d => `
            <div class="border-l-2 border-maserati-plata/30 pl-3 pb-2 transition-colors hover:border-maserati-azul group cursor-default">
                <div class="flex justify-between items-center">
                    <p class="text-white text-sm font-bold group-hover:text-maserati-amber transition-colors">${d.name}</p>
                    <span class="text-[9px] uppercase border border-maserati-plata/20 px-1 rounded text-maserati-plata">${d.type}</span>
                </div>
                <p class="text-xs text-maserati-plata mt-1">${d.address}</p>
                <p class="text-[10px] text-maserati-cian mt-1 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    ${d.dist ? d.dist.toFixed(0) + ' km de distancia' : 'Calculando...'}
                </p>
            </div>
        `).join('');
    }


    function initGeo() {
        if (navigator.geolocation) {
            if(locateBtn) locateBtn.innerText = "Localizando...";
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    findNearest(position.coords.latitude, position.coords.longitude);
                    if(locateBtn) locateBtn.innerText = "Ubicación Actualizada";
                },
                (error) => {
                    console.log("Geo denegada o error");
                    renderDealerships([dealerships[0], dealerships[2], dealerships[3]]); 
                    if(locateBtn) locateBtn.innerText = "Actualizar Ubicación (Permiso denegado)";
                }
            );
        } else {
            renderDealerships([dealerships[0], dealerships[2], dealerships[3]]);
        }
    }

    document.addEventListener('DOMContentLoaded', initGeo);
    locateBtn?.addEventListener('click', initGeo);



    const form = document.getElementById('contact-form') as HTMLFormElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const successMsg = document.getElementById('feedback-success');
    const errorMsg = document.getElementById('feedback-error');

    form?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const name = formData.get('name');
        
        if (!name) { 
            errorMsg?.classList.remove('hidden');
            return;
        }

        if(submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="animate-pulse">Enviando...</span>';
            submitBtn.classList.add('opacity-70');
        }

        setTimeout(() => {
            if(submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ENVIAR SOLICITUD';
                submitBtn.classList.remove('opacity-70');
            }
            successMsg?.classList.remove('hidden');
            errorMsg?.classList.add('hidden');
            form.reset();
        }, 1500);
    });
</script>